require 'dotenv/load'
require_relative 'config/environment.rb'

class Cache < Thor
  desc "cache data", "Extract recipes from mobile API and store in Redis cache"
  def all
    puts "Caching recipes locally"
    offset = 0
    client = Redis.new(host: 'redis')

    loop do
      response = HTTParty.get("https://mobileapi.jumbo.com/v6/recipes?count=500&offset=#{offset}")
      offset = offset + 500

      json_response = JSON.parse(response.body)

      json_response['recipes']['data'].each do |result|
        recipe_response = HTTParty.get("https://mobileapi.jumbo.com/v6/recipes/#{result['id']}")
        sleep(0.2)
        json_recipe = JSON.parse(recipe_response.body)

        client.hset('recipes', json_recipe['recipe']['data']['id'], json_recipe['recipe']['data'].to_json)
        puts "Cached recipe #{json_recipe['recipe']['data']['id']}"
      end

      break if offset > json_response['recipes']['total']
    end

    puts "Cached #{client.hlen('recipes')} recipes"
  end
end
